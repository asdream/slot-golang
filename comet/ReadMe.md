#Comet 设计说明
---

##Comet解决了什么问题

Comet代理手机或设备的连接。

代理手机时，为了保持跟用户长连接，使用基于Tcp的Websocket协议跟客户端通讯，以及将数据传递给中间层的MsgBus服务器。

代理设备时，采用UDP协议，接收设备的注册、登录等请求，并翻译为HTTP协议调用后端的HTTP服务器，并将相应结果翻译后返回至设备。
设备代理服务器与设备的应用层协议参考相关文档。

---

##Comet的一些概念

1. Comet是无状态服务器，所有的状态建立都是在用户登陆时刻完成，中间不修改任何状态，修改也是需要重新登陆
2. Comet服务器不做掉线重连功能
3. Comet服务器支持两类消息，一类是发送点对点不需要回应的，另一类需要回应。

##Comet的设计

1. 采用一致性Hash将用户的ID进行散列存储(将用户的数量散列到128个桶中)
2. 时间ID的设计（用于存储SessionId)  
	* 时间每次产生采用纳秒  
    * 应该保存最后一次产生的Id时间  
    * 新生成的id时间应该大于前面生成的id  
    * 如果小于则需要Sleep  
    * id是64位, 高8位代表机器的id，剩余54位从2012年后开始算起  
    * 保证线程安全  
3. 为用户只开一个上行的GoRoutine
4. 下行推送数据的时候可以临时开GoRoutine
5. 用户的下线和推送数据必须保证线程安全
6. 每个连接所用的buff都是可以服用的（优先级较低）
7. websocket采用谷歌官方库
8. 支持多个端口监听

##Comet达成的目标

1. 同时在线1000k+
2. 每秒消息上行100k+，下行100k+
3. 机器的GC时间不超过500ms

##Comet监控信息

1. 所建立的全部连接数
2. 当前连接总数
3. 上行消息数量（成功+失败）
4. 下行消息数量（成功+失败）
5. 当前用户数量或者设备数量
6. 登陆请求量（成功+失败）
7. 机器状态和版本和配置文件信息
8. gc的状态和routine信息

##Zookeeper协调

1. 每个comet服务器都有一个唯一id标识
2. 上传自己的配置文件信息到zookeeper
3. 注册到zookeeper中，并且是临时节点
4. 定时更新zookeeper的信息，例如当前服务器的一些状态，在线人数等等
5. 已经在zookeeper中注册的机器不能再注册，也就是服务器首先去zookeeper注册自己才能启动

## 问题：

协议问题：

* 服务器回应是否加密？怎样加密？
* 临时Token在注册和登录时提供，具体怎样的使用流程？每个UDP请求均携带？
* 获取临时Token，des加密后为24字节，不是16字节
* 注册接口未提供mac
* 注册设备的HTTP接口不返回平台id
* HTTP服务器返回的cookie并不是固定的64字节
